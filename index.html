<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Cloud Storage</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        :root {
            --primary: #4285F4;
            --error: #EA4335;
            --success: #34A853;
            --warning: #FBBC05;
            --gray: #f5f5f5;
            --dark-gray: #333;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--gray);
            color: var(--dark-gray);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        #userInfo {
            display: none;
            align-items: center;
        }
        
        #userPhoto {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
        }
        
        #loginContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70vh;
        }
        
        .login-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--primary);
            text-align: center;
        }
        
        .login-subtitle {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 40px;
            text-align: center;
            max-width: 600px;
            line-height: 1.6;
        }
        
        #fileUpload {
            display: none;
            margin-top: 30px;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        }
        
        #uploadArea {
            border: 2px dashed #ccc;
            padding: 50px;
            text-align: center;
            margin-bottom: 25px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        #uploadArea:hover {
            border-color: var(--primary);
            background-color: #f8fbff;
        }
        
        #uploadArea.highlight {
            border-color: var(--primary);
            background-color: #f0f7ff;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 1rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-danger {
            background-color: var(--error);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d33426;
        }
        
        #filesList {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        }
        
        .files-header {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr;
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            color: #555;
        }
        
        .file-item {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr;
            padding: 15px 10px;
            border-bottom: 1px solid #f5f5f5;
            align-items: center;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-icon {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .file-icon i {
            color: var(--primary);
            font-size: 1.4rem;
        }
        
        .progress-container {
            margin-top: 20px;
            background: #f1f1f1;
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--dark-gray);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background-color: var(--success);
        }
        
        .toast.error {
            background-color: var(--error);
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 0;
            color: #777;
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .files-header, .file-item {
                grid-template-columns: 2fr 1fr 1fr;
            }
            
            .file-type {
                display: none;
            }
            
            #uploadArea {
                padding: 30px 15px;
            }
            
            .login-title {
                font-size: 2rem;
            }
            
            .login-subtitle {
                font-size: 1rem;
                padding: 0 15px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Cloud Storage</h1>
            <div id="userInfo">
                <img id="userPhoto" src="" alt="User Photo">
                <span id="userName"></span>
                <button id="logoutBtn" class="btn btn-danger" style="margin-left: 15px;">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="loginContainer">
            <h2 class="login-title">Secure Cloud Storage</h2>
            <p class="login-subtitle">Store your files, photos, and documents safely in the cloud with Google authentication. Access your data from anywhere, anytime.</p>
            
            <!-- Google Sign-In Button -->
            <div id="g_id_onload"
                data-client_id="16728591390-8v9h5v3m3a6q7b2p4r5t6y7u8i9o0p1a2s3d4f5g.apps.googleusercontent.com"
                data-context="signin"
                data-ux_mode="popup"
                data-callback="handleGoogleSignIn"
                data-auto_prompt="false">
            </div>
            
            <div class="g_id_signin"
                data-type="standard"
                data-shape="rectangular"
                data-theme="filled_blue"
                data-text="signin_with"
                data-size="large"
                data-width="300"
                data-logo_alignment="left">
            </div>
        </div>

        <div id="fileUpload">
            <div id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3>Drag & Drop Files Here</h3>
                <p>or</p>
                <button id="uploadBtn" class="btn btn-primary">Select Files</button>
                <input type="file" id="fileInput" multiple style="display: none;">
            </div>
            
            <div id="uploadProgress" class="progress-container" style="display: none;">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div id="progressText" style="text-align: center; margin: 15px 0; color: #555; font-size: 0.9rem;"></div>
            
            <div id="filesList">
                <div class="files-header">
                    <span>Name</span>
                    <span>Size</span>
                    <span>Type</span>
                    <span>Actions</span>
                </div>
                <div id="filesContainer">
                    <div class="empty-state">
                        <i class="fas fa-cloud"></i><br>
                        No files uploaded yet
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // =================================
        // Firebase Configuration and Setup
        // =================================
        const firebaseConfig = {
            apiKey: "AIzaSyDQCKkrAe9k20XGV1n58TVC6OZeaV3wDv8",
            authDomain: "zmx-trader-v1-8a94a.firebaseapp.com",
            projectId: "zmx-trader-v1-8a94a",
            storageBucket: "zmx-trader-v1-8a94a.appspot.com",
            messagingSenderId: "16728591390",
            appId: "1:16728591390:web:3127669ba6f1b9a812320f"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const storage = firebase.storage();

        // =================================
        // Google Sign-In Implementation
        // =================================
        function handleGoogleSignIn(response) {
            const credential = firebase.auth.GoogleAuthProvider.credential(response.credential);
            
            auth.signInWithCredential(credential)
                .then((userCredential) => {
                    showToast('Signed in successfully!', 'success');
                    const user = userCredential.user;
                    updateUIAfterLogin(user);
                    loadFiles();
                })
                .catch((error) => {
                    console.error("Sign-in error:", error);
                    showToast('Sign-in failed: ' + error.message, 'error');
                    // Reset Google Sign-In button
                    google.accounts.id.renderButton(
                        document.querySelector('.g_id_signin'), 
                        { 
                            type: 'standard',
                            shape: 'rectangular',
                            theme: 'filled_blue',
                            text: 'signin_with',
                            size: 'large',
                            width: 300,
                            logo_alignment: 'left'
                        }
                    );
                });
        }

        function updateUIAfterLogin(user) {
            // Update user info in header
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userPhoto').src = user.photoURL || 'https://via.placeholder.com/40';
            document.getElementById('userName').textContent = user.displayName || 'User';
            
            // Switch to file upload interface
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('fileUpload').style.display = 'block';
        }

        // =================================
        // Authentication State Management
        // =================================
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                updateUIAfterLogin(user);
                loadFiles();
            } else {
                // User is signed out
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('fileUpload').style.display = 'none';
                
                // Render Google Sign-In button if not already rendered
                if (!document.querySelector('.g_id_signin').hasChildNodes()) {
                    google.accounts.id.renderButton(
                        document.querySelector('.g_id_signin'), 
                        { 
                            type: 'standard',
                            shape: 'rectangular',
                            theme: 'filled_blue',
                            text: 'signin_with',
                            size: 'large',
                            width: 300,
                            logo_alignment: 'left'
                        }
                    );
                }
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut().then(() => {
                showToast('Signed out successfully', 'success');
                // Reset the Google Sign-In button
                google.accounts.id.disableAutoSelect();
                google.accounts.id.prompt();
            }).catch((error) => {
                console.error("Logout error:", error);
                showToast('Logout failed: ' + error.message, 'error');
            });
        });

        // =================================
        // File Upload Functionality
        // =================================
        document.getElementById('uploadBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            handleFiles(e.target.files);
            e.target.value = ''; // Reset input to allow uploading same file again
        });

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            uploadArea.classList.add('highlight');
        }

        function unhighlight() {
            uploadArea.classList.remove('highlight');
        }

        uploadArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        });

        function handleFiles(files) {
            if (!files || files.length === 0) return;
            
            const user = auth.currentUser;
            if (!user) {
                showToast('Please sign in to upload files', 'error');
                return;
            }
            
            // Show progress UI
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('progressBar').style.width = '0%';
            
            // Process each file
            Array.from(files).forEach((file, index) => {
                uploadFile(file, index, files.length);
            });
        }

        function uploadFile(file, index, totalFiles) {
            const user = auth.currentUser;
            const storageRef = storage.ref();
            const fileRef = storageRef.child(`users/${user.uid}/${file.name}`);
            const uploadTask = fileRef.put(file);
            
            // Update progress text
            let progressText = `Uploading ${file.name} (${index + 1}/${totalFiles})`;
            document.getElementById('progressText').textContent = progressText;
            
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Progress monitoring
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressText').textContent = 
                        `${progressText}: ${Math.round(progress)}%`;
                },
                (error) => {
                    console.error("Upload error:", error);
                    showToast(`Upload failed: ${file.name}`, 'error');
                    if (index === totalFiles - 1) {
                        document.getElementById('uploadProgress').style.display = 'none';
                    }
                },
                () => {
                    // Upload complete
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        showToast(`${file.name} uploaded successfully!`, 'success');
                        
                        if (index === totalFiles - 1) {
                            document.getElementById('uploadProgress').style.display = 'none';
                            document.getElementById('progressBar').style.width = '0%';
                            loadFiles();
                        }
                    });
                }
            );
        }

        // =================================
        // File Management Functions
        // =================================
        function loadFiles() {
            const user = auth.currentUser;
            if (!user) return;
            
            const storageRef = storage.ref();
            const userRef = storageRef.child(`users/${user.uid}`);
            const filesContainer = document.getElementById('filesContainer');
            
            filesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i> Loading files...</div>';
            
            userRef.listAll().then((res) => {
                if (res.items.length === 0) {
                    filesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><br>No files found. Upload some files to get started.</div>';
                    return;
                }
                
                filesContainer.innerHTML = '';
                
                res.items.forEach((itemRef) => {
                    itemRef.getMetadata().then((metadata) => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        
                        const fileType = getFileType(metadata.name);
                        const fileIcon = getFileIcon(fileType);
                        
                        fileItem.innerHTML = `
                            <div class="file-icon">
                                <i class="${fileIcon}"></i>
                                <span>${metadata.name}</span>
                            </div>
                            <span>${formatFileSize(metadata.size)}</span>
                            <span class="file-type">${fileType.toUpperCase()}</span>
                            <div>
                                <button class="btn btn-secondary" onclick="downloadFile('${metadata.name}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteFile('${metadata.name}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        filesContainer.appendChild(fileItem);
                    }).catch((error) => {
                        console.error("Error getting metadata:", error);
                    });
                });
            }).catch((error) => {
                console.error("Error listing files:", error);
                filesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><br>Error loading files. Please try again.</div>';
                showToast('Error loading files: ' + error.message, 'error');
            });
        }

        function getFileType(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const typeMap = {
                // Images
                jpg: 'image', jpeg: 'image', png: 'image', gif: 'image', webp: 'image', svg: 'image', bmp: 'image',
                // Documents
                pdf: 'pdf', doc: 'doc', docx: 'doc', xls: 'xls', xlsx: 'xls', ppt: 'ppt', pptx: 'ppt',
                txt: 'text', csv: 'text', rtf: 'text', md: 'text',
                // Archives
                zip: 'zip', rar: 'zip', '7z': 'zip', tar: 'zip', gz: 'zip',
                // Audio/Video
                mp3: 'audio', wav: 'audio', ogg: 'audio', mp4: 'video', mkv: 'video', mov: 'video', avi: 'video',
                // Code
                html: 'code', css: 'code', js: 'code', json: 'code', php: 'code', py: 'code', java: 'code', cpp: 'code',
                // Other
                exe: 'binary', dmg: 'binary', pkg: 'binary'
            };
            return typeMap[extension] || 'file';
        }

        function getFileIcon(fileType) {
            const iconMap = {
                image: 'fas fa-image',
                pdf: 'fas fa-file-pdf',
                doc: 'fas fa-file-word',
                xls: 'fas fa-file-excel',
                ppt: 'fas fa-file-powerpoint',
                text: 'fas fa-file-alt',
                zip: 'fas fa-file-archive',
                audio: 'fas fa-file-audio',
                video: 'fas fa-file-video',
                code: 'fas fa-file-code',
                binary: 'fas fa-file',
                file: 'fas fa-file'
            };
            return iconMap[fileType] || 'fas fa-file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadFile(filename) {
            const user = auth.currentUser;
            const storageRef = storage.ref();
            const fileRef = storageRef.child(`users/${user.uid}/${filename}`);
            
            showToast(`Preparing download for ${filename}...`, 'success');
            
            fileRef.getDownloadURL().then((url) => {
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToast(`Download started: ${filename}`, 'success');
            }).catch((error) => {
                console.error("Download error:", error);
                showToast(`Download failed: ${filename}`, 'error');
            });
        }

        function deleteFile(filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"? This action cannot be undone.`)) {
                return;
            }
            
            const user = auth.currentUser;
            const storageRef = storage.ref();
            const fileRef = storageRef.child(`users/${user.uid}/${filename}`);
            
            fileRef.delete().then(() => {
                showToast(`File deleted: ${filename}`, 'success');
                loadFiles();
            }).catch((error) => {
                console.error("Delete error:", error);
                showToast(`Delete failed: ${filename}`, 'error');
            });
        }

        // =================================
        // UI Helper Functions
        // =================================
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast';
            toast.classList.add(type);
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Check if the user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    updateUIAfterLogin(user);
                    loadFiles();
                }
            });
            
            // Initialize Google Sign-In button
            google.accounts.id.initialize({
                client_id: "16728591390-8v9h5v3m3a6q7b2p4r5t6y7u8i9o0p1a2s3d4f5g.apps.googleusercontent.com",
                callback: handleGoogleSignIn
            });
            
            google.accounts.id.renderButton(
                document.querySelector('.g_id_signin'), 
                { 
                    type: 'standard',
                    shape: 'rectangular',
                    theme: 'filled_blue',
                    text: 'signin_with',
                    size: 'large',
                    width: 300,
                    logo_alignment: 'left'
                }
            );
            
            google.accounts.id.prompt();
        });
    </script>
</body>
</html>
